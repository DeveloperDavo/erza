# -*- mode: Shell-script-*-

#!/usr/bin/env bash

echo '****** RESTORE ******'
db=/tmp/restore/shelf2.sql
consul=/tmp/restore/consul.json
repo=/srv/erza

docker exec -t shelf2 envconsul -consul-addr consul:8500 -prefix shelf2-backend -upcase rake db:create || { echo 'ERROR: Database could not be created' ; exit 1; }

if [ ! -f ${db} ] ; then
    echo "Db backup is not there"
    exit 1
fi

if ! docker exec -t shelf2 rake status ; then
    echo 'Restoring Database'
    cat $db | docker exec -i db bash -c 'mysql --password=$DB_PASSWORD shelf2_production' 2> /dev/null || { echo 'ERROR: Database could not be restored' ; exit 1; }
else
    echo 'Database does not need to be restored'
fi

if [ ! -f ${consul} ] ; then
    echo "Consul backup is not there"
    exit 1
fi

docker exec -i consul consul kv import "$(cat ${consul})"

(crontab -l 2>/dev/null; echo "0 6 1 * * sh ${repo}/bin/renew") | crontab -
